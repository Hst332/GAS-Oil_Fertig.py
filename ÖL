#!/usr/bin/env python3
"""
oil_price_forecast.py
Professional, calm, robust oil forecast (WTI + Brent)

Logic:
- Yahoo Finance only
- Trend + momentum model
- Trade only if probability >= threshold
"""

import json
import numpy as np
import pandas as pd
from datetime import datetime
import yfinance as yf

from sklearn.ensemble import RandomForestClassifier
from sklearn.model_selection import TimeSeriesSplit
from sklearn.metrics import accuracy_score

# ======================
# CONFIG
# ======================
START_DATE = "2012-01-01"
WTI_SYMBOL = "CL=F"
BRENT_SYMBOL = "BZ=F"

PROB_THRESHOLD = 0.57   # trade only above this
OUTPUT_TXT = "oil_forecast_output.txt"
OUTPUT_JSON = "oil_forecast_output.json"

# ======================
# LOAD DATA
# ======================
def load_prices():
    wti = yf.download(WTI_SYMBOL, start=START_DATE, progress=False)["Close"]
    brent = yf.download(BRENT_SYMBOL, start=START_DATE, progress=False)["Close"]

    df = pd.concat([wti, brent], axis=1)
    df.columns = ["WTI_Close", "Brent_Close"]
    df.dropna(inplace=True)
    return df

# ======================
# FEATURES
# ======================
def build_features(df):
    df = df.copy()

    df["WTI_Return"] = df["WTI_Close"].pct_change()
    df["Brent_Return"] = df["Brent_Close"].pct_change()

    for lag in range(1, 6):
        df[f"WTI_lag{lag}"] = df["WTI_Return"].shift(lag)
        df[f"Brent_lag{lag}"] = df["Brent_Return"].shift(lag)

    df["Momentum_10"] = df["WTI_Close"].pct_change(10).shift(1)
    df["Volatility_5"] = df["WTI_Return"].rolling(5).std().shift(1)

    # Target: next day up/down
    df["Target"] = (df["WTI_Return"].shift(-1) > 0).astype(int)

    df.dropna(inplace=True)
    return df

# ======================
# MODEL
# ======================
def train_model(df, features):
    X = df[features]
    y = df["Target"]

    tscv = TimeSeriesSplit(n_splits=5)
    scores = []

    for train, test in tscv.split(X):
        model = RandomForestClassifier(
            n_estimators=300,
            max_depth=6,
            min_samples_leaf=5,
            random_state=42
        )
        model.fit(X.iloc[train], y.iloc[train])
        pred = model.predict(X.iloc[test])
        scores.append(accuracy_score(y.iloc[test], pred))

    final_model = RandomForestClassifier(
        n_estimators=300,
        max_depth=6,
        min_samples_leaf=5,
        random_state=42
    )
    final_model.fit(X, y)

    return final_model, np.mean(scores), np.std(scores)

# ======================
# OUTPUT
# ======================
def write_output(result):
    lines = [
        "===================================",
        "      OIL PRICE FORECAST",
        "===================================",
        f"Run time (UTC): {result['run_time']}",
        f"Data date     : {result['data_date']}",
        "",
        f"WTI Close     : {result['WTI_Close']:.2f}",
        f"Brent Close   : {result['Brent_Close']:.2f}",
        "",
        f"Prob UP       : {result['prob_up']:.2%}",
        f"Signal        : {result['signal']}",
        f"Confidence    : {result['confidence']:.2%}",
        "",
        f"Model CV      : {result['cv_mean']:.2%} Â± {result['cv_std']:.2%}",
        "===================================",
    ]

    with open(OUTPUT_TXT, "w") as f:
        f.write("\n".join(lines))

    with open(OUTPUT_JSON, "w") as f:
        json.dump(result, f, indent=2)

# ======================
# MAIN
# ======================
def main():
    prices = load_prices()
    df = build_features(prices)

    features = [c for c in df.columns if c not in ("Target", "WTI_Close", "Brent_Close")]

    model, cv_mean, cv_std = train_model(df, features)

    last = df.iloc[-1:]
    prob_up = model.predict_proba(last[features])[0][1]

    signal = "NO_TRADE"
    if prob_up >= PROB_THRESHOLD:
        signal = "LONG"

    result = {
        "run_time": datetime.utcnow().strftime("%Y-%m-%d %H:%M:%S UTC"),
        "data_date": last.index[0].date().isoformat(),
        "WTI_Close": float(last["WTI_Close"]),
        "Brent_Close": float(last["Brent_Close"]),
        "prob_up": float(prob_up),
        "signal": signal,
        "confidence": float(prob_up),
        "cv_mean": float(cv_mean),
        "cv_std": float(cv_std),
    }

    write_output(result)

if __name__ == "__main__":
    main()
